
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, -scalable=no" />
    <title>CRACKED HACK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&family=Righteous&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              'sans': ['Inter', 'ui-sans-serif', 'system-ui'],
              'mono': ['JetBrains Mono', 'ui-monospace', 'monospace'],
              'righteous': ['Righteous', 'cursive'],
            },
            animation: { 'gradient': 'gradient 8s linear infinite', 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'bounce-slow': 'bounce 2s infinite', 'float': 'float 6s ease-in-out infinite', 'glow': 'glow 2s ease-in-out infinite alternate', 'fade-in': 'fadeIn 0.5s ease-out forwards', 'slide-in-up': 'slideInUp 0.5s ease-out forwards', 'pop-in': 'popIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards', 'nav-tap': 'navTap 0.3s ease-out', 'victory-pop': 'victoryPop 1.5s ease-out forwards', 'victory-glow': 'victoryGlow 1.5s infinite alternate', 'jackpot-pulse': 'jackpotPulse 1.5s ease-in-out infinite', },
            keyframes: {
              gradient: { '0%, 100%': { 'background-size': '200% 200%', 'background-position': 'left center' }, '50%': { 'background-size': '200% 200%', 'background-position': 'right center' }},
              float: { '0%, 100%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-10px)' }},
              glow: { 'from': { 'box-shadow': '0 0 20px rgba(147, 51, 234, 0.3)' }, 'to': { 'box-shadow': '0 0 30px rgba(147, 51, 234, 0.6)' }},
              fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 }},
              slideInUp: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 }},
              popIn: { '0%': { transform: 'scale(0.8)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 }},
              navTap: { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.05)' }, '100%': { transform: 'scale(1)' }},
              victoryPop: { '0%': { transform: 'scale(0.5) translateY(50px)', opacity: 0, filter: 'blur(10px)' }, '60%': { transform: 'scale(1.1) translateY(0px)', opacity: 1, filter: 'blur(0px)' }, '100%': { transform: 'scale(1) translateY(0px)', opacity: 1 }},
              victoryGlow: { '0%': { textShadow: '0 0 5px #ffeb3b, 0 0 10px #ffeb3b' }, '50%': { textShadow: '0 0 15px #ffd700, 0 0 30px #ffd700, 0 0 45px #ffeb3b' }, '100%': { textShadow: '0 0 5px #ffeb3b, 0 0 10px #ffeb3b' }},
              jackpotPulse: { '0%, 100%': { transform: 'scale(1)', filter: 'hue-rotate(0deg)' }, '50%': { transform: 'scale(1.02)', filter: 'hue-rotate(15deg)' } }
            }
          }
        }
    </script>
    <style>
      html, body { height: 100%; overflow: hidden; font-family: "Inter", sans-serif; background: #0f172a; overscroll-behavior: none; }
      .app-container { display: none; flex-direction: column; height: 100vh; width: 100vw; background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%); transition: filter 0.3s ease-in-out; }
      .app-container.active { display: flex; }
      .app-container.frozen { filter: blur(8px) brightness(0.6); pointer-events: none; }
      .app-header { flex-shrink: 0; animation: fadeIn 0.5s ease-out; }
      .app-content { flex-grow: 1; overflow-y: auto; padding: 1rem; -webkit-overflow-scrolling: touch; }
      .app-content > div { animation: slideInUp 0.5s ease-out forwards; }
      .glass-effect { backdrop-filter: blur(20px) saturate(180%); background: rgba(15, 23, 42, 0.75); border: 1px solid rgba(255, 255, 255, 0.1); }
      .auth-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 3000; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease; padding: 1rem; }
      .login-screen { background: #0f172a; }
      .popup-screen { background: rgba(15, 23, 42, 0.5); }
      .bottom-nav { flex-shrink: 0; position: relative; width: 100%; z-index: 1000; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(15px); border-top: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3); }
      .nav-button { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px 0; color: #94a3b8; font-size: 0.75rem; font-weight: 500; transition: all 0.2s ease-in-out; position: relative; flex-grow: 1; }
      .nav-button:hover { color: #ffffff; transform: translateY(-2px); }
      .nav-button.active { color: #c084fc; font-weight: 700; animation: navTap 0.3s ease-out; }
      .nav-button.active::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; border-radius: 50%; background: #c084fc; box-shadow: 0 0 10px #c084fc, 0 0 20px #c084fc; }
      
      /* Styles for manual result button */
      .result-input-button {
          padding: 4px 12px; /* Adjusted padding */
          border-radius: 9999px; /* Full rounded corners */
          font-size: 0.8rem; /* Slightly larger font */
          font-weight: 600;
          color: white;
          background-color: #6366f1; /* Indigo color */
          border: 1px solid #4f46e5;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
          transition: all 0.2s ease;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          min-width: 80px; /* Increased min-width */
          /* margin-left: auto; /* Push to the right - removed for full width button */
      }
      .result-input-button:hover {
          background-color: #4f46e5;
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }

      /* Jackpot Picker Overlay */
      #jackpot-picker-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 5000;
          opacity: 0;
          visibility: hidden;
          transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      #jackpot-picker-overlay.active {
          opacity: 1;
          visibility: visible;
      }
      .jackpot-picker-content {
          background: #1e293b;
          border-radius: 1rem;
          padding: 1.5rem;
          box-shadow: 0 10px 20px rgba(0,0,0,0.5);
          text-align: center;
          animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
          max-width: 90%;
      }
      .jackpot-number-grid {
          display: grid;
          grid-template-columns: repeat(5, 1fr); /* 5 columns */
          gap: 0.5rem;
          margin-top: 1rem;
      }
      .jackpot-number-button {
          background-color: #334155;
          color: white;
          padding: 0.75rem;
          border-radius: 0.5rem;
          font-size: 1.2rem;
          font-weight: bold;
          cursor: pointer;
          transition: background-color 0.2s ease, transform 0.1s ease;
          border: 1px solid rgba(255,255,255,0.1);
      }
      .jackpot-number-button:hover {
          background-color: #475569;
          transform: scale(1.05);
      }
      .jackpot-number-button:active {
          transform: scale(0.95);
      }

      /* New: Level/Method Picker Overlay */
      #level-method-picker-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 5000;
          opacity: 0;
          visibility: hidden;
          transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      #level-method-picker-overlay.active {
          opacity: 1;
          visibility: visible;
      }
      .level-method-picker-content {
          background: #1e293b;
          border-radius: 1rem;
          padding: 1.5rem;
          box-shadow: 0 10px 20px rgba(0,0,0,0.5);
          text-align: center;
          animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
          max-width: 90%;
          width: 350px;
      }
      .method-button {
          padding: 10px 20px;
          border-radius: 0.5rem;
          font-weight: bold;
          transition: all 0.2s ease;
          border: 1px solid transparent;
      }
      .method-button.active {
          background-color: #c084fc;
          border-color: #a78bfa;
          color: white;
      }
      .method-button:not(.active) {
          background-color: #334155;
          color: #cbd5e1;
      }
      .method-button:not(.active):hover {
          background-color: #475569;
      }
    </style>
</head>
<body class="text-gray-100">

    <div id="login-overlay" class="auth-overlay login-screen">
        <div class="w-full max-w-sm p-6 space-y-4 glass-effect rounded-2xl animate-pop-in">
             <div class="text-center">
                <img src="https://i.postimg.cc/j5qKpyQQ/F6-DD5838-2-DC4-4532-9237-E09-A073057-F5.jpg" alt="Logo" class="w-24 h-24 mx-auto rounded-full border-4 border-purple-500/50 p-1 mb-2"/>
                <h1 class="text-4xl font-righteous bg-gradient-to-r from-purple-400 via-pink-500 to-orange-400 bg-clip-text text-transparent pb-1">DM WIN</h1>
                <p class="text-gray-300 text-sm font-semibold tracking-wider">NUMBER HACK</p>
            </div>
            
            <div class="text-center">
                <a href="https://bigmumbai.life/#/register?invitationCode=534761246140" target="_blank" class="inline-block py-2 px-6 text-sm font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors">
                    REGISTER NOW
                </a>
            </div>

            <form id="login-form" class="space-y-4 border-t border-slate-700/50 pt-4">
                <div>
                    <label for="key-input" class="text-sm font-medium text-gray-300">Your Key</label>
                    <input id="key-input" type="text" required class="w-full p-3 mt-1 bg-slate-800 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter your key">
                </div>
                 <div>
                    <label for="uid-input" class="text-sm font-medium text-gray-300">Your Game UID</label>
                    <input id="uid-input" type="number" required class="w-full p-3 mt-1 bg-slate-800 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter your Game User ID">
                </div>
                <button type="submit" class="w-full py-3 font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors">Login</button>
            </form>
            <p id="login-error" class="text-center text-red-400 text-sm h-4"></p>
            
            <div class="mt-2 text-center border-t border-slate-700 pt-4">
                <p class="text-sm text-gray-400 mb-2">Don't have a key?</p>
                <a href="https://t.me/RajaluckVipHacks" target="_blank" class="w-full inline-block py-2.5 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                    GET KEY NOW 
                </a>
            </div>
        </div>
    </div>
    
    <div id="expired-overlay" class="auth-overlay popup-screen hidden">
        <div class="w-full max-w-sm p-8 space-y-4 text-center glass-effect rounded-2xl animate-pop-in">
            <i class="fas fa-exclamation-triangle text-5xl text-yellow-400 mb-4 animate-bounce-slow"></i>
            <h1 class="text-2xl font-bold text-white">Session Expired</h1>
            <p class="text-gray-300">Your key is invalid or has expired. Redirecting to login...</p>
        </div>
    </div>

    <div id="app-container" class="app-container">
        <header class="app-header p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="https://i.postimg.cc/HsGsj491/jhgvhh.png" alt="Logo" class="w-12 h-12 rounded-full border-2 border-purple-500/50 p-1"/>
                    <div>
                      <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent">HITLER'S PAID HACK CRACKED</h1>
                      <p class="text-xs text-gray-400">Prediction Dashboard</p>
                    </div>
                </div>
                 <div class="flex items-center space-x-2 bg-slate-800/50 rounded-lg px-3 py-1.5">
                    <i class="fas fa-clock text-blue-400 text-xs"></i>
                    <div id="indianTime" class="text-xs font-mono text-gray-300"></div>
                </div>
            </div>
        </header>

        <main class="app-content scrollbar-thin">
            <div id="home-page">
              <div class="space-y-6">
                <div class="glass-effect rounded-2xl p-6 premium-shadow text-center space-y-4 animate-pop-in">
                  <div class="flex items-center justify-center space-x-2">
                      <i class="fas fa-crystal-ball text-purple-400 text-lg animate-bounce-slow"></i>
                      <p class="text-lg font-semibold text-purple-300">HITLER THE HUNTER</p>
                  </div>
                  <p class="text-4xl font-bold bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent min-h-[52px] flex items-center justify-center font-mono" id="prediction">--</p>
                  <!-- New div for home page action button -->
                  <div id="home-prediction-action" class="mt-4"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-effect rounded-xl p-4 text-center animate-pop-in" style="animation-delay: 0.1s;">
                       <p class="text-sm font-semibold text-gray-400 mb-1">Period No</p>
                       <p class="text-2xl font-bold text-blue-400 font-mono" id="currentPeriod">Loading...</p>
                    </div>
                     <div class="glass-effect rounded-xl p-4 text-center animate-pop-in" style="animation-delay: 0.2s;">
                       <p class="text-sm font-semibold text-gray-400 mb-1">Countdown</p>
                       <p id="timer" class="text-2xl font-bold text-white font-mono animate-pulse-slow">--</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-effect rounded-xl p-4 text-center animate-pop-in" style="animation-delay: 0.3s;">
                        <p class="text-sm font-semibold text-gray-400 mb-1">Server Status</p>
                        <p class="text-md font-bold" id="serverStatus"><span class="animate-pulse"><i class="fas fa-spinner fa-spin mr-2"></i>Connecting...</span></p>
                    </div>
                     <div class="glass-effect rounded-xl p-4 text-center animate-pop-in" style="animation-delay: 0.4s;">
                        <p class="text-sm font-bold text-gray-400 mb-1">AI Strategy</p>
                        <p class="text-md font-bold text-cyan-400" id="strategyStatus">HITLER XT V1</p>
                    </div>
                </div>

                <!-- New section for Telegram CTA -->
                <div class="glass-effect rounded-2xl p-4 premium-shadow text-center space-y-3 mt-6 animate-slide-in-up">
                    <p class="text-sm font-semibold text-gray-300">
                        WANT TO GET FREE KEYS, OFFERS AND MORE DETAILS? JOIN NOW ðŸ‘‡
                    </p>
                    <button id="telegram-join-btn" class="w-full py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2">
                        <i class="fab fa-telegram-plane text-xl"></i>
                        <span>JOIN TELEGRAM CHANNEL</span>
                    </button>
                </div>
              </div>
            </div>

            <div id="history-page" class="hidden">
                 <div class="glass-effect rounded-2xl p-4 premium-shadow">
                    <div class="flex items-center space-x-3 mb-4 px-2">
                        <i class="fas fa-history text-xl text-indigo-400"></i>
                        <h2 class="text-xl font-bold text-gray-200">Prediction History</h2>
                    </div>
                    <div id="history" class="space-y-3"></div>
                </div>
            </div>

            <div id="stats-page" class="hidden">
                <div class="space-y-4">
                    <div class="glass-effect rounded-2xl p-4 premium-shadow animate-pop-in">
                      <div class="flex items-center space-x-4">
                        <i class="fas fa-percentage text-3xl text-green-400"></i>
                        <div> <p class="text-sm font-medium text-gray-400">Overall Win Rate</p> <p class="text-3xl font-bold text-green-400 font-mono" id="winRate">0.00%</p> </div>
                      </div>
                    </div>
                    <div class="glass-effect rounded-2xl p-4 premium-shadow animate-pop-in" style="animation-delay: 0.1s;">
                       <div class="flex items-center space-x-4">
                        <i class="fas fa-chart-bar text-3xl text-blue-400"></i>
                        <div> <p class="text-sm font-medium text-gray-400">Total Wins / Losses</p> <p class="text-2xl font-bold text-gray-200 font-mono"> <span id="totalWins" class="text-green-400">0</span> / <span id="totalLosses" class="text-red-400">0</span> </p> </div>
                      </div>
                    </div>

                    <!-- New: YOUR GAME BALANCE section -->
                    <div class="glass-effect rounded-2xl p-4 premium-shadow animate-pop-in" style="animation-delay: 0.2s;">
                        <div class="flex items-center space-x-3 mb-4 px-2">
                            <i class="fas fa-wallet text-xl text-teal-400"></i>
                            <h2 class="text-xl font-bold text-gray-200">YOUR GAME BALANCE</h2>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label for="balance-input" class="text-sm font-medium text-gray-300">Enter Your Balance (â‚¹)</label>
                                <input id="balance-input" type="number" min="0" required class="w-full p-3 mt-1 bg-slate-800 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="ENTER YOUR BMB GAME BALANCE">
                            </div>
                            <button id="confirm-balance-btn" class="w-full py-2.5 font-semibold text-white bg-teal-600 rounded-lg hover:bg-teal-700 transition-colors">Confirm</button>
                            <p id="balance-error" class="text-center text-red-400 text-sm h-4"></p>
                            <div id="fund-division-display" class="mt-4 space-y-2">
                                <!-- Fund division results will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="profile-page" class="hidden">
                 <div class="glass-effect rounded-2xl p-6 premium-shadow space-y-6">
                    <div class="flex items-center space-x-4">
                         <i class="fas fa-user-circle text-5xl text-purple-400"></i>
                         <div>
                            <h2 class="text-xl font-bold text-white">Your Profile</h2>
                            <p class="text-gray-400 font-mono" id="profile-uid">UID: ...</p>
                         </div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-lg">
                            <span class="text-gray-300">Key Details:</span>
                            <span class="font-bold text-white" id="profile-price">...</span>
                        </div>
                         <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-lg">
                            <span class="text-gray-300">Time Left:</span>
                            <span class="font-bold text-white font-mono text-lg" id="profile-expiry">--:--:--</span>
                        </div>
                    </div>
                    <!-- New: Offer Template -->
                    <div class="glass-effect rounded-xl p-4 text-center space-y-2 border border-yellow-400/30 animate-pop-in" style="background: rgba(253, 224, 71, 0.1);">
                        <p class="text-lg font-bold text-yellow-300">SPECIAL OFFER!</p>
                        <p class="text-2xl font-extrabold text-white">
                            <span class="text-green-400">5999â‚¹</span> for <span class="text-blue-400">1 Year</span>
                        </p>
                        <p class="text-xl font-bold bg-gradient-to-r from-red-400 to-orange-400 bg-clip-text text-transparent">
                            SAVE <span class="text-yellow-400">85%</span> NOW!
                        </p>
                        <button id="offer-telegram-btn" class="w-full py-2.5 font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center space-x-2 mt-3">
                            <i class="fab fa-telegram-plane"></i>
                            <span>CLAIM THE OFFER NOW!</span>
                        </button>
                    </div>
                    <button id="logout-btn" class="w-full mt-4 py-3 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center space-x-2">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                 </div>
            </div>
        </main>

        <nav class="bottom-nav flex justify-around">
            <button class="nav-button active" data-page="home-page"><i class="fas fa-home text-xl mb-1"></i><span>Home</span></button>
            <button class="nav-button" data-page="history-page"><i class="fas fa-scroll text-xl mb-1"></i><span>History</span></button>
            <button class="nav-button" data-page="stats-page"><i class="fas fa-chart-pie text-xl mb-1"></i><span>Stats</span></button>
            <button class="nav-button" data-page="profile-page"><i class="fas fa-user text-xl mb-1"></i><span>Profile</span></button>
        </nav>
    </div>

    <div id="victory-message" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-70 z-[4000] hidden">
        <span id="victory-message-text" class="text-6xl font-extrabold text-yellow-300 animate-victory-pop animate-victory-glow">WINN!</span>
    </div>

    <!-- Jackpot Number Picker Overlay -->
    <div id="jackpot-picker-overlay" class="hidden">
        <div class="jackpot-picker-content">
            <h3 class="text-xl font-bold text-white mb-4">Select Result Number (0-9)</h3>
            <div class="jackpot-number-grid">
                <button class="jackpot-number-button" data-number="0">0</button>
                <button class="jackpot-number-button" data-number="1">1</button>
                <button class="jackpot-number-button" data-number="2">2</button>
                <button class="jackpot-number-button" data-number="3">3</button>
                <button class="jackpot-number-button" data-number="4">4</button>
                <button class="jackpot-number-button" data-number="5">5</button>
                <button class="jackpot-number-button" data-number="6">6</button>
                <button class="jackpot-number-button" data-number="7">7</button>
                <button class="jackpot-number-button" data-number="8">8</button>
                <button class="jackpot-number-button" data-number="9">9</button>
            </div>
            <button id="cancel-jackpot-picker" class="mt-6 py-2 px-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">Cancel</button>
        </div>
    </div>

    <!-- New: Level/Method Picker Overlay -->
    <div id="level-method-picker-overlay" class="hidden">
        <div class="level-method-picker-content">
            <h3 class="text-xl font-bold text-white mb-4">Choose Your Strategy</h3>
            <div class="space-y-4">
                <div>
                    <label for="level-input" class="text-sm font-medium text-gray-300">Choose Your Level (1-7)</label>
                    <input id="level-input" type="number" min="1" max="7" required class="w-full p-3 mt-1 bg-slate-800 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="ENTER THE LEVEL">
                    <p id="level-error" class="text-red-400 text-sm mt-1 h-4"></p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-300">Bet Method</label>
                    <div class="flex justify-center space-x-4 mt-2">
                        <button id="method-2x-btn" class="method-button flex-1">2X METHOD</button>
                        <button id="method-3x-btn" class="method-button flex-1">3X METHOD</button>
                    </div>
                    <p id="method-error" class="text-red-400 text-sm mt-1 h-4"></p>
                </div>
                <button id="calculate-funds-btn" class="w-full py-3 font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors">Calculate Funds</button>
                <button id="cancel-level-method-picker" class="w-full py-2 px-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors mt-2">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA94FdXIQ3xlFV7zZYobtbOgL5hWkkGLzY",
            authDomain: "my-new-project-5c838.firebaseapp.com",
            databaseURL: "https://my-new-project-5c838-default-rtdb.firebaseio.com",
            projectId: "my-new-project-5c838",
            storageBucket: "my-new-project-5c838.appspot.com",
            messagingSenderId: "51780072067",
            appId: "1:51780072067:web:demoappid",
        };

        const loginOverlay = document.getElementById('login-overlay');
        const expiredOverlay = document.getElementById('expired-overlay');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const keyInput = document.getElementById('key-input');
        const uidInput = document.getElementById('uid-input');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const telegramJoinBtn = document.getElementById('telegram-join-btn'); 
        const offerTelegramBtn = document.getElementById('offer-telegram-btn'); 
        const jackpotPickerOverlay = document.getElementById('jackpot-picker-overlay');
        const jackpotNumberButtons = document.querySelectorAll('.jackpot-number-button');
        const cancelJackpotPickerBtn = document.getElementById('cancel-jackpot-picker');
        const homePredictionActionEl = document.getElementById('home-prediction-action'); // New element

        // New elements for Game Balance feature
        const balanceInput = document.getElementById('balance-input');
        const confirmBalanceBtn = document.getElementById('confirm-balance-btn');
        const balanceError = document.getElementById('balance-error');
        const fundDivisionDisplay = document.getElementById('fund-division-display');
        const levelMethodPickerOverlay = document.getElementById('level-method-picker-overlay');
        const levelInput = document.getElementById('level-input');
        const levelError = document.getElementById('level-error');
        const method2XBtn = document.getElementById('method-2x-btn');
        const method3XBtn = document.getElementById('method-3x-btn');
        const methodError = document.getElementById('method-error');
        const calculateFundsBtn = document.getElementById('calculate-funds-btn');
        const cancelLevelMethodPickerBtn = document.getElementById('cancel-level-method-picker');
        
        let sessionCheckUnsubscribe = null;
        let expiryTimerInterval = null; 
        let logoutInProgress = false;
        let currentPeriodForPicker = null; 
        let currentStatusIntendedForPicker = null;

        // New state variables for Game Balance and Prediction Flow
        let gameBalance = 0;
        let selectedLevel = 0;
        let selectedBetMethod = null; // "2X" or "3X"
        let isCurrentPeriodAwaitingInput = false; // Flag to control prediction generation flow
        let currentPeriodPrediction = null; // Stores the current prediction object awaiting user input

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        /**
         * Starts a timer to display the remaining time until key expiry.
         * If the key expires, it triggers a logout.
         * @param {number} expiryTimestamp - The timestamp (in milliseconds) when the key expires.
         */
        function startExpiryTimer(expiryTimestamp) {
            if (expiryTimerInterval) clearInterval(expiryTimerInterval);
            const expiryEl = document.getElementById('profile-expiry');
            
            expiryTimerInterval = setInterval(() => {
                if (logoutInProgress) {
                    clearInterval(expiryTimerInterval);
                    return;
                }
                const now = Date.now();
                const remaining = expiryTimestamp - now;

                if (remaining <= 0) {
                    expiryEl.textContent = "EXPIRED";
                    expiryEl.classList.add('text-red-500');
                    logout(true); // Force logout if expired
                    return;
                }

                const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
                const hours = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

                let timerString = '';
                if (days > 0) timerString += `${days}d `;
                timerString += `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                expiryEl.textContent = timerString;

                if (remaining < 5 * 60 * 1000) { // Less than 5 minutes remaining, show warning
                    expiryEl.classList.remove('text-white');
                    expiryEl.classList.add('text-yellow-400', 'animate-pulse');
                } else {
                    expiryEl.classList.add('text-white');
                    expiryEl.classList.remove('text-yellow-400', 'animate-pulse');
                }
            }, 1000);
        }

        /**
         * Handles the user login process by validating the key and UID against Firestore.
         * @param {string} key - The user's key.
         * @param {string} uid - The user's game UID.
         */
         
     async function handleLogin(key, uid) {
    loginError.textContent = 'Verifying...';

    // Skip checking key against database, just simulate a successful response
    const fakeKeyDoc = { id: 'fakeKeyId' };
    const fakeKeyData = {
        expiry: Date.now() + 100000000, // far future expiry
        usedBy: [uid],
        deviceLimit: 9999, // effectively unlimited
    };

    // Call the success handler directly
    onLoginSuccess(fakeKeyDoc.id, uid, fakeKeyData);
}


        /**
         * Actions to perform upon successful login.
         * @param {string} docId - The Firestore document ID for the key.
         * @param {string} uid - The user's game UID.
         * @param {object} keyData - The data associated with the key.
         */
        function onLoginSuccess(docId, uid, keyData) {
            localStorage.setItem('userSession', JSON.stringify({ docId, uid }));
            loginOverlay.style.opacity = '0';
            setTimeout(() => loginOverlay.style.display = 'none', 500);
            appContainer.classList.add('active');
            document.getElementById('profile-uid').textContent = `UID: ${uid}`;
            document.getElementById('profile-price').textContent = keyData.price || 'N/A';
            
            startExpiryTimer(keyData.expiry);
            initializeDashboard();
            startSessionCheck(docId);
        }

        /**
         * Starts a real-time listener to check the session status in Firestore.
         * If the key document is deleted or becomes invalid, it forces a logout.
         * @param {string} docId - The Firestore document ID for the key.
         */
function startSessionCheck(docId) {
    // Stop any previous listener
    if (sessionCheckUnsubscribe) sessionCheckUnsubscribe();

    const docRef = doc(db, "keys", docId);

    // Start listener, but do nothing on deletion
    sessionCheckUnsubscribe = onSnapshot(docRef, (docSnap) => {
        // Previously: logout(true); now: do nothing
        if (!docSnap.exists()) {
            console.warn("Key document deleted, but session will continue.");
        }
    }, (error) => {
        console.error("Firestore session check error:", error);
        // Previously: logout(true); now: do nothing
    });
}

/**
 * Logs out the user, clearing session data and reloading the page.
 * @param {boolean} isForced - Ignored, always does normal reload now
 */
function logout(isForced = false) {
    if (logoutInProgress) return;

    // Clear timers and listeners
    if (expiryTimerInterval) clearInterval(expiryTimerInterval);
    if (sessionCheckUnsubscribe) sessionCheckUnsubscribe();

    // Clear session data
    localStorage.removeItem('userSession');

    // Simple reload only (no overlay, no force logout)
    window.location.reload();
}


        // Event listeners for login and logout
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const key = keyInput.value.trim();
            const uid = uidInput.value.trim();
            if (key && uid) handleLogin(key, uid);
        });
        
        logoutBtn.addEventListener('click', () => logout(false));

        // Event listener for Telegram button on Home page
        telegramJoinBtn.addEventListener('click', () => {
            window.open('https://t.me/RajaluckVipHacks', '_blank');
        });

        // Event listener for Telegram button on Profile page
        offerTelegramBtn.addEventListener('click', () => {
            window.open('https://t.me/RajaluckVipHacks', '_blank');
        });
        
        // Check for existing session on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const sessionString = localStorage.getItem('userSession');
            if(sessionString) {
                try {
                    const { docId, uid } = JSON.parse(sessionString);
                    const docSnap = await getDocs(query(collection(db, "keys"), where("__name__", "==", docId)));
                    if (!docSnap.empty) {
                        const keyDoc = docSnap.docs[0];
                        if (Date.now() < keyDoc.data().expiry) {
                           onLoginSuccess(docId, uid, keyDoc.data());
                        } else {
                           logout(true); // Key expired, force logout
                        }
                    } else {
                        logout(true); // Key doc not found, force logout
                    }
                } catch (e) {
                    console.error("Error parsing session or fetching key:", e);
                    localStorage.removeItem('userSession');
                    // Optionally, show login page or specific error
                }
            }
        });

        // Main dashboard initialization function
        function initializeDashboard() {
            const navButtons = document.querySelectorAll('.nav-button');
            const pages = document.querySelectorAll('.app-content > div');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetPageId = button.dataset.page;
                    pages.forEach(page => page.classList.add('hidden'));
                    document.getElementById(targetPageId).classList.remove('hidden');
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                });
            });

            // Constants for prediction logic
            const bigNumbers = [5, 6, 7, 8, 9];
            const smallNumbers = [0, 1, 2, 3, 4];
            
            let historyData = []; // Stores prediction history
            let currentPeriod = null; // Current period number
            let timerInterval; // Interval for countdown timer
            let useOppositeLogic = false; // Flag for HITLER XT V1/V2 dynamic switching

            // DOM elements
            const serverStatusEl = document.getElementById("serverStatus");
            const currentPeriodEl = document.getElementById("currentPeriod");
            const predictionEl = document.getElementById("prediction");
            const timerEl = document.getElementById("timer");
            const indianTimeEl = document.getElementById("indianTime");
            const winRateEl = document.getElementById("winRate");
            const totalWinsEl = document.getElementById("totalWins");
            const totalLossesEl = document.getElementById("totalLosses");
            const historyEl = document.getElementById("history");
            const strategyStatusEl = document.getElementById("strategyStatus");
            const victoryMessage = document.getElementById("victory-message");
            const victoryMessageText = document.getElementById("victory-message-text");

            // Set initial strategy display name
            if (strategyStatusEl) strategyStatusEl.textContent = `HITLER XT V1`;

            /**
             * Gets the current Indian Standard Time (IST).
             * @returns {Date} A Date object representing the current IST.
             */
            function getIndianTime() {
                const now = new Date();
                const utc = now.getTime() + (now.getTimezoneOffset() * 60000); // Convert to UTC
                const indiaOffset = 330 * 60000; // IST is UTC+5:30
                return new Date(utc + indiaOffset);
            }
            
            /**
             * Fetches game results from the external API. This is used ONLY for the prediction logic,
             * not for determining win/loss/jackpot for history entries.
             * @returns {Promise<object|null>} The API data or null if an error occurs.
             */
            async function fetchGameResultForPrediction() {
                if (logoutInProgress) return null;
                try {
                    // Using pageSize: 10 to ensure we can get the 8th and 9th previous results (indices 7 and 8)
                    const payload = { pageSize: 10, pageNo: 1, typeId: 1, language: 0, random: "4a0522c6ecd8410496260e686be2a57c", signature: "334B5E70A0C9B8918B0B15E517E2069C", timestamp: Math.floor(Date.now() / 1000) };
                    const response = await fetch("https://api.bdg88zf.com/api/webapi/GetNoaverageEmerdList", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if (serverStatusEl) serverStatusEl.innerHTML = `<span class="text-green-400 flex items-center justify-center"><i class="fas fa-check-circle mr-2"></i>Connected</span>`;
                    return data?.data || null;
                } catch (error) {
                    console.error("Error fetching game result for prediction:", error);
                    if (serverStatusEl) serverStatusEl.innerHTML = `<span class="text-red-400 flex items-center justify-center"><i class="fas fa-exclamation-triangle mr-2"></i>Disconnected</span>`;
                    return null;
                }
            }

            /**
             * Displays a victory message (WINN! or JACKPOT!).
             * @param {string} status - The status to display ("WIN" or "JACKPOT").
             */
            function showVictoryMessage(status) {
                victoryMessageText.innerText = status === 'JACKPOT' ? "JACKPOT!" : "WINN!";
                victoryMessage.classList.remove('hidden'); 
                setTimeout(() => { 
                    victoryMessage.classList.add('hidden'); // Hide after animation
                }, 2500);
            }
            
            /**
             * Updates the prediction based on the new logic (8th and 9th previous results)
             * and manages the manual result input flow.
             */
            async function updatePrediction() {
                if (logoutInProgress) return;

                // If the current period is awaiting manual input, display message and button
                if (isCurrentPeriodAwaitingInput && currentPeriodPrediction && currentPeriodPrediction.isPeriodEnded) {
                    predictionEl.innerText = "PLEASE GIVE RESULT";
                    timerEl.innerText = "INPUT REQUIRED";
                    homePredictionActionEl.innerHTML = `
                        <button class="result-input-button w-full mt-4" data-period="${currentPeriodPrediction.period}">RESULT..?</button>
                    `;
                    // Attach event listener to the dynamically created button
                    homePredictionActionEl.querySelector('.result-input-button').onclick = (event) => {
                        showJackpotPicker(event.target.dataset.period, "MANUAL_INPUT");
                    };
                    return; // Stop here, waiting for user input
                }

                // If we reach here, it means we need to generate a new prediction
                homePredictionActionEl.innerHTML = ''; // Clear any previous "RESULT..?" button on home
                predictionEl.innerText = "--"; // Clear previous prediction display

                const resultData = await fetchGameResultForPrediction();
                if (!resultData || !resultData.list) {
                    if (!logoutInProgress) setTimeout(updatePrediction, 5000); // Retry fetching
                    return;
                }
                const list = resultData.list;

                // Ensure we have enough data for 8th and 9th previous results (indices 7 and 8)
                if (list.length < 9) { // Need at least 9 items for list[8] to exist
                    console.warn("Not enough data (less than 9 periods) for new strategy. Waiting for more data.");
                    predictionEl.innerText = "Waiting for data...";
                    if (!logoutInProgress) setTimeout(updatePrediction, 5000); // Retry fetching
                    return;
                }

                // --- NEW PREDICTION LOGIC ---
                const eighthPreviousResult = list[7]; // The 8th latest result (index 7)
                const ninthPreviousResult = list[8]; // The 9th latest result (index 8)

                // Calculation for 8th period: (last digit of period - result) % 10
                const period8thLastDigit = parseInt(eighthPreviousResult.issueNumber.toString().slice(-1));
                const result8th = eighthPreviousResult.number;
                const calc8th = (period8thLastDigit - result8th + 10) % 10; // Ensure positive single digit (0-9)

                // Calculation for 9th period: (last digit of period - result) % 10
                const period9thLastDigit = parseInt(ninthPreviousResult.issueNumber.toString().slice(-1));
                const result9th = ninthPreviousResult.number;
                const calc9th = (period9thLastDigit - result9th + 10) % 10; // Ensure positive single digit (0-9)

                // Final Calculation: (9th + 8th) % 10
                let finalSum = (calc9th + calc8th) % 10; // Sum and ensure single digit (0-9)

                let basePredictedType;
                let baseTargetNumbersPool; // This pool contains all numbers of the predicted type

                if (finalSum >= 5) {
                    basePredictedType = "BIG";
                    baseTargetNumbersPool = [5, 6, 7, 8, 9];
                } else {
                    basePredictedType = "SMALL";
                    baseTargetNumbersPool = [0, 1, 2, 3, 4];
                }

                let finalPredictedType = basePredictedType;
                let finalTargetNumbersPool = baseTargetNumbersPool;

                // Apply dynamic V2 logic if useOppositeLogic is true (set by manual loss)
                if (useOppositeLogic) {
                    finalPredictedType = (basePredictedType === "BIG" ? "SMALL" : "BIG");
                    finalTargetNumbersPool = (basePredictedType === "BIG" ? smallNumbers : bigNumbers);
                }

                // num1 is the finalSum itself. num2 is another distinct number from the target pool.
                let num1 = finalSum;
                let num2;

                // Filter out num1 from the target pool to pick num2
                const poolForNum2 = finalTargetNumbersPool.filter(n => n !== num1);

                if (poolForNum2.length > 0) {
                    num2 = poolForNum2[Math.floor(Math.random() * poolForNum2.length)];
                } else {
                    // This fallback handles cases where finalSum is the only number of its type
                    // (e.g., if target pool was just [0] and finalSum was 0). For [0-4] or [5-9]
                    // this shouldn't be hit as there are multiple numbers.
                    num2 = num1; 
                }
                
                const predictionText = `${finalPredictedType} ${Math.min(num1, num2)}/${Math.max(num1, num2)}`;
                predictionEl.innerText = predictionText;
                // --- END NEW PREDICTION LOGIC ---

                // Update current period number based on the latest result from API + 2
                currentPeriod = (BigInt(list[0].issueNumber) + 2n).toString();
                currentPeriodEl.innerText = currentPeriod.slice(-4);

                // Create new history item for the current prediction
                const newPredictionItem = {
                    period: currentPeriod,
                    prediction: predictionText,
                    result: null,
                    resultStatus: "Pending",
                    isCurrentPending: true, // Mark this as the one awaiting input
                    isPeriodEnded: false // Will be true when countdown finishes
                };

                // Before adding new, if there was a previous 'current pending', mark it as not current
                if (historyData.length > 0 && historyData[0].isCurrentPending) {
                    historyData[0].isCurrentPending = false;
                }

                historyData.unshift(newPredictionItem); // Add new prediction to the beginning of history
                if (historyData.length > 20) historyData.pop(); // Keep history limited to 20 items

                currentPeriodPrediction = newPredictionItem; // Set the current prediction object that needs user input
                isCurrentPeriodAwaitingInput = false; // Reset this flag as a new prediction is generated and countdown starts

                updateHistory(); // Update history display
                calculateStats(); // Update stats
                startCountdown(); // Start countdown for the new prediction
            }

            /**
             * Calculates and updates the win/loss statistics.
             */
            function calculateStats() {
                const wins = historyData.filter((i) => i.resultStatus === "WIN" || i.resultStatus === "JACKPOT").length;
                const losses = historyData.filter((i) => i.resultStatus === "LOSS").length;
                totalWinsEl.innerText = wins; totalLossesEl.innerText = losses;
                winRateEl.innerText = (wins + losses > 0 ? (wins / (wins + losses)) * 100 : 0).toFixed(2) + "%";
            }

            /**
             * Updates the history display in the UI.
             * Renders a single "RESULT..?" button for manual result input for past periods.
             */
            function updateHistory() {
                historyEl.innerHTML = "";
                historyData.forEach((item, index) => {
                    let statusText, statusIcon, statusColor;
                    let resultDisplay = '';
                    let actionHtml = ''; // This will hold either the "RESULT..?" button or the status text

                    // Determine display properties based on current status
                    switch (item.resultStatus) {
                        case "JACKPOT": statusText = "JACKPOT"; statusIcon = "fas fa-crown"; statusColor = "text-yellow-400"; break;
                        case "WIN": statusText = "WIN"; statusIcon = "fas fa-check-circle"; statusColor = "text-green-400"; break;
                        case "LOSS": statusText = "LOSS"; statusIcon = "fas fa-times-circle"; statusColor = "text-red-400"; break;
                        default: statusText = "Pending"; statusIcon = "fas fa-hourglass-half fa-spin"; statusColor = "text-blue-400"; break;
                    }

                    // Determine color for the result number based on even/odd or special numbers (0, 5)
                    let resultStyle = '';
                    if (item.result !== null) {
                        if (item.result === 0) {
                            // Top half red, bottom half violet
                            resultStyle = `background-image: linear-gradient(to bottom, #ef4444 50%, #8a2be2 50%); -webkit-background-clip: text; background-clip: text; color: transparent;`;
                        } else if (item.result === 5) {
                            // Top half green, bottom half violet
                            resultStyle = `background-image: linear-gradient(to bottom, #34d399 50%, #8a2be2 50%); -webkit-background-clip: text; background-clip: text; color: transparent;`;
                        } else {
                            // Red for even, Green for odd
                            resultStyle = `color: ${(item.result % 2 === 0) ? '#ef4444' : '#34d399'};`;
                        }
                        resultDisplay = `<p class="font-bold text-lg" style="${resultStyle}">${item.result}</p>`;
                    } else {
                        resultDisplay = `<i class="fas fa-question text-gray-500"></i>`;
                    }

                    // Only show "RESULT..?" button for past pending periods (not the current one on home page)
                    // A past pending period is one that has resultStatus "Pending" AND isCurrentPending is false
                    if (item.resultStatus === "Pending" && !item.isCurrentPending) {
                        actionHtml = `
                            <button class="result-input-button" data-period="${item.period}">RESULT..?</button>
                        `;
                    } else {
                        // For the current pending prediction (if it's not yet resolved) or already resolved items, display status
                        actionHtml = `
                            <div class="flex items-center space-x-2 ${statusColor} ml-auto">
                                <i class="${statusIcon} text-xs"></i>
                                <span class="font-bold text-md">${statusText}</span>
                            </div>
                        `;
                    }

                    const div = document.createElement("div");
                    div.className = `history-card flex items-center justify-between p-3 rounded-xl glass-effect mb-2`;
                    div.style.animationDelay = `${index * 0.05}s`;
                    div.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <div class="text-center w-12">
                                <p class="font-semibold text-gray-300 font-mono text-sm">${item.period.slice(-4)}</p>
                                ${resultDisplay}
                            </div>
                            <div class="flex-grow"> <!-- This div contains the prediction text and will take available space -->
                                <p class="text-md font-semibold text-gray-300">${item.prediction}</p>
                            </div>
                        </div>
                        ${actionHtml}
                    `;
                    historyEl.appendChild(div);
                });

                // Add event listeners to the newly created "RESULT..?" buttons for *past* history items
                document.querySelectorAll('#history .result-input-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const period = event.target.dataset.period;
                        showJackpotPicker(period, "MANUAL_INPUT"); 
                    });
                });
            }

            /**
             * Handles manual setting of a prediction's result (Win/Loss/Jackpot) based on selected number.
             * @param {string} period - The period number to update.
             * @param {string} intendedStatus - The status the user *intended* to set (this is now a generic "MANUAL_INPUT").
             * @param {number} selectedNumber - The number selected by the user in the picker.
             */
            function handleManualResult(period, intendedStatus, selectedNumber) {
                const itemIndex = historyData.findIndex(item => item.period === period);
                if (itemIndex !== -1) {
                    const item = historyData[itemIndex];
                    item.result = selectedNumber; // Set the selected number as the result

                    const predictionParts = item.prediction.split(" ");
                    const predictedType = predictionParts[0]; // "BIG" or "SMALL"
                    const predictedNumbers = predictionParts[1].split("/").map(Number); // e.g., [1, 3]

                    let actualOutcome = ""; // To store the true outcome (WIN, LOSS, JACKPOT)
                    
                    // Determine actual outcome based on selected number and prediction
                    if (predictedNumbers.includes(selectedNumber)) {
                        actualOutcome = "JACKPOT"; // Selected number was one of the predicted jackpot numbers
                    } else {
                        const actualType = selectedNumber >= 5 ? "BIG" : "SMALL";
                        if (actualType === predictedType) {
                            actualOutcome = "WIN"; // Selected number matches predicted type but not a jackpot number
                        } else {
                            actualOutcome = "LOSS"; // Selected number does not match predicted type
                        }
                    }

                    item.resultStatus = actualOutcome; // Update the item's status

                    // Adjust useOppositeLogic and show victory message based on actual outcome
                    if (actualOutcome === "WIN" || actualOutcome === "JACKPOT") {
                        showVictoryMessage(actualOutcome);
                        useOppositeLogic = false; // Win/Jackpot, so next prediction is V1 (normal)
                    } else { // actualOutcome === "LOSS"
                        useOppositeLogic = true; // Loss, so next prediction is V2 (opposite)
                    }

                    // Update strategy display for the *next* prediction
                    strategyStatusEl.innerHTML = useOppositeLogic ? '<i class="fas fa-robot mr-1"></i>HITLER XT V2' : '<i class="fas fa-lightbulb mr-1"></i>HITLER XT V1';
                    
                    // --- NEW LOGIC AFTER MANUAL INPUT ---
                    item.isCurrentPending = false; // This item is no longer pending input
                    item.isPeriodEnded = false; // Reset this flag for the item
                    currentPeriodPrediction = null; // Clear the current pending prediction object
                    isCurrentPeriodAwaitingInput = false; // Reset the flag
                    // --- END NEW LOGIC ---

                    updateHistory();
                    calculateStats();
                    updatePrediction(); // Generate the next prediction now that input is given
                }
            }

            /**
             * Displays the jackpot number picker overlay.
             * @param {string} period - The period number for which the result is being set.
             * @param {string} intendedStatus - The status the user *intended* to set (now a generic "MANUAL_INPUT").
             */
            function showJackpotPicker(period, intendedStatus) {
                currentPeriodForPicker = period;
                currentStatusIntendedForPicker = intendedStatus;
                jackpotPickerOverlay.classList.remove('hidden');
                jackpotPickerOverlay.classList.add('active');
            }

            /**
             * Hides the jackpot number picker overlay.
             */
            function hideJackpotPicker() {
                jackpotPickerOverlay.classList.remove('active');
                setTimeout(() => jackpotPickerOverlay.classList.add('hidden'), 300); // Hide after transition
                currentPeriodForPicker = null;
                currentStatusIntendedForPicker = null;
            }

            // Event listeners for jackpot number buttons
            jackpotNumberButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const selectedNumber = parseInt(event.target.dataset.number, 10);
                    if (currentPeriodForPicker !== null && currentStatusIntendedForPicker !== null) {
                        handleManualResult(currentPeriodForPicker, currentStatusIntendedForPicker, selectedNumber);
                    }
                    hideJackpotPicker();
                });
            });

            // Event listener for cancel button in jackpot picker
            cancelJackpotPickerBtn.addEventListener('click', hideJackpotPicker);

            /**
             * Starts or updates the countdown timer for the next prediction.
             */
            function startCountdown() {
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    if (logoutInProgress) { clearInterval(timerInterval); return; }
                    const remaining = 60 - getIndianTime().getSeconds();
                    timerEl.innerHTML = remaining > 5 ? `${remaining}s` : `<span class="text-yellow-400">${remaining}s</span>`;
                    
                    if (remaining <= 3) {
                        timerEl.innerHTML = `<i class="fas fa-sync-alt fa-spin"></i>`;
                        clearInterval(timerInterval);

                        // --- NEW LOGIC FOR END OF PERIOD ---
                        // If there's a current pending prediction, mark it as ended and awaiting input
                        if (currentPeriodPrediction && currentPeriodPrediction.isCurrentPending) {
                            currentPeriodPrediction.isPeriodEnded = true; // Mark this specific item as ended
                            isCurrentPeriodAwaitingInput = true; // Set global flag
                            updatePrediction(); // Call updatePrediction to refresh UI with "PLEASE GIVE RESULT"
                        } else {
                            // Fallback, if for some reason currentPeriodPrediction is not set,
                            // or it was already resolved. This should ideally not be hit in normal flow.
                            setTimeout(updatePrediction, 3500); 
                        }
                        // --- END NEW LOGIC ---
                    }
                }, 1000);
            }

            // Update Indian time display every second
            setInterval(() => {
                if (indianTimeEl) indianTimeEl.innerText = getIndianTime().toLocaleTimeString("en-IN", { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'});
            }, 1000);

            // Initial call to start the prediction engine.
            updatePrediction();

            // --- New Game Balance Logic ---

            /**
             * Shows the level and method picker overlay.
             */
            function showLevelMethodPicker() {
                levelMethodPickerOverlay.classList.remove('hidden');
                levelMethodPickerOverlay.classList.add('active');
                levelError.textContent = ''; // Clear previous errors
                methodError.textContent = '';
                // Reset method buttons active state
                method2XBtn.classList.remove('active');
                method3XBtn.classList.remove('active');
                selectedBetMethod = null;
            }

            /**
             * Hides the level and method picker overlay.
             */
            function hideLevelMethodPicker() {
                levelMethodPickerOverlay.classList.remove('active');
                setTimeout(() => levelMethodPickerOverlay.classList.add('hidden'), 300);
            }

            /**
             * Calculates and displays the fund division based on user inputs.
             * Ensures funds for each level (except last) end in 0 or 5.
             */
            function calculateAndDisplayFunds() {
                // Get and validate level input
                const level = parseInt(levelInput.value, 10);
                if (isNaN(level) || level < 1 || level > 7) {
                    levelError.textContent = 'Please enter a level between 1 and 7.';
                    return;
                } else {
                    levelError.textContent = '';
                }
                selectedLevel = level;

                // Validate bet method selection
                if (!selectedBetMethod) {
                    methodError.textContent = 'Please select a bet method (2X or 3X).';
                    return;
                } else {
                    methodError.textContent = '';
                }

                // Calculate total parts needed (sum of multiplier^i for i from 0 to level-1)
                let totalParts = 0;
                const multiplier = parseInt(selectedBetMethod.replace('X', ''), 10);
                for (let i = 0; i < selectedLevel; i++) {
                    totalParts += Math.pow(multiplier, i);
                }

                // Calculate the raw base unit (L1 fund)
                let baseUnit = Math.floor(gameBalance / totalParts);

                // Adjust baseUnit to ensure it ends in 0 or 5
                const lastDigit = baseUnit % 10;
                if (lastDigit !== 0 && lastDigit !== 5) {
                    if (lastDigit > 5) {
                        baseUnit -= (lastDigit - 5); // e.g., 28 -> 25, 26 -> 25
                    } else { // lastDigit is 1, 2, 3, 4
                        baseUnit -= lastDigit; // e.g., 23 -> 20, 21 -> 20
                    }
                }

                // If baseUnit becomes 0 after adjustment, it means balance is too low
                if (baseUnit <= 0) {
                    fundDivisionDisplay.innerHTML = `
                        <p class="text-red-400 text-center">Your balance (â‚¹${gameBalance}) is too low to start with a base unit ending in 0 or 5 for ${selectedLevel} levels with ${selectedBetMethod}. Try a lower level or a smaller multiplier.</p>
                    `;
                    hideLevelMethodPicker();
                    return;
                }

                // Calculate funds for each level
                let levelFunds = [];
                let sumOfCalculatedFunds = 0;
                for (let i = 0; i < selectedLevel; i++) {
                    const currentLevelFund = baseUnit * Math.pow(multiplier, i);
                    levelFunds.push(currentLevelFund);
                    sumOfCalculatedFunds += currentLevelFund;
                }

                // Calculate remaining balance and add to the last level
                const remainingBalance = gameBalance - sumOfCalculatedFunds;
                if (levelFunds.length > 0) {
                    levelFunds[selectedLevel - 1] += remainingBalance;
                }
                
                // Display fund division
                let fundsHtml = `<p class="text-lg font-bold text-gray-200 mb-2 text-center">Fund Division (â‚¹${gameBalance}, ${selectedLevel} Levels, ${selectedBetMethod}):</p>`;
                fundsHtml += `<div class="space-y-1">`;
                levelFunds.forEach((fund, i) => {
                    fundsHtml += `
                        <div class="flex justify-between items-center bg-slate-800/50 p-2 rounded-md">
                            <span class="text-gray-300">Level ${i + 1}:</span>
                            <span class="font-bold text-green-400">${fund}â‚¹</span>
                        </div>
                    `;
                });
                fundsHtml += `</div>`;
                fundDivisionDisplay.innerHTML = fundsHtml;
                hideLevelMethodPicker(); // Hide picker after calculation
            }

            // Event listener for Confirm Balance button
            confirmBalanceBtn.addEventListener('click', () => {
                const balance = parseInt(balanceInput.value, 10);
                if (isNaN(balance) || balance <= 0) {
                    balanceError.textContent = 'Please enter a valid positive balance.';
                    return;
                }
                balanceError.textContent = '';
                gameBalance = balance;
                showLevelMethodPicker();
            });

            // Event listeners for Bet Method buttons
            method2XBtn.addEventListener('click', () => {
                selectedBetMethod = '2X';
                method2XBtn.classList.add('active');
                method3XBtn.classList.remove('active');
                methodError.textContent = '';
            });

            method3XBtn.addEventListener('click', () => {
                selectedBetMethod = '3X';
                method3XBtn.classList.add('active');
                method2XBtn.classList.remove('active');
                methodError.textContent = '';
            });

            // Event listener for Calculate Funds button in the picker
            calculateFundsBtn.addEventListener('click', calculateAndDisplayFunds);

            // Event listener for Cancel button in the picker
            cancelLevelMethodPickerBtn.addEventListener('click', hideLevelMethodPicker);

        } // Closing brace for initializeDashboard
    </script>
</body>
</html>